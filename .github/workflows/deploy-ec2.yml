name: Deploy to EC2

on:
  push:
    branches: [ "main", "release/*" ]

jobs:
  # [1단계] 테스트 로봇 (CI)
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          
      - name: Install uv and dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.cargo/env
          uv sync --frozen
          
      - name: Run Tests
        run: |
          source $HOME/.cargo/env
          uv run pytest  # 여기서 실패하면 아래 배포 단계로 안 넘어감!

  # [2단계] 배포 로봇 (CD)
  deploy:
    needs: test  # <--- 중요! 테스트가 성공해야만 배포를 시작함
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ec2-user/upstage-network-lecture
            git fetch my-repo ${{ github.ref_name }}
            git reset --hard my-repo/${{ github.ref_name }}
            ./start.sh